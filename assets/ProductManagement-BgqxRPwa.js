import{p as Y,r as b,d as O,q as z,o as q,s as Z,j as ee,i as H,c as v,a as _,e,t as $,v as l,x as U,y as k,z as te,A as le,B as oe,m as W,F as D,f as N,n as L,g as E,w as se}from"./index-0U5cSJyf.js";import{_ as ae}from"./DeleteModal.vue_vue_type_script_setup_true_lang-BSFvBMQb.js";import{M as ne}from"./bootstrap.esm-Ctwlr2Hi.js";import{D as ie}from"./DefaultContainer-CYBuJ9Nn.js";const re="https://ec-course-api.hexschool.io/",R="ifjewelrystyle",P=Y.create({baseURL:re});P.interceptors.request.use(o=>{const a=document.cookie.replace(/(?:(?:^|.*;\s*)hexToken\s*=\s*([^;]*).*$)|^.*$/,"$1");return a&&(o.headers.Authorization=a),o},o=>Promise.reject(o));P.interceptors.response.use(o=>Promise.resolve(o),o=>Promise.reject(o.response.data));const de=o=>P.get(`/v2/api/${R}/admin/products`,{params:o}),ue=o=>P.post(`/v2/api/${R}/admin/product`,{data:o}),ce=o=>{const{data:a,id:g}=o;return P.put(`/v2/api/${R}/admin/product/${g}`,{data:a})},pe=o=>P.delete(`/v2/api/${R}/admin/product/${o}`),me=async o=>await P.post(`/v2/api/${R}/admin/upload`,o),F=4;function ge(o){try{const a=new URL(o);return["http:","https:"].includes(a.protocol)}catch(a){return console.error(a),!1}}async function fe(o){const a=new FormData;a.append("file-to-upload",o);try{return(await me(a)).data.imageUrl}catch(g){throw alert("上傳圖片失敗"),g}}function be(o=[]){const a=b([...o]),g=b(""),i=b("未選擇檔案。"),c=b(null),r=b(!1);return{uploadedImages:a,imageUrlInput:g,fileNameDisplay:i,fileToUpload:c,isUploading:r,addImageUrl:()=>{const m=g.value.trim();if(m){if(a.value.length>=F){alert(`最多只能上傳 ${F} 張圖片`);return}if(!ge(m)){alert("請輸入有效的圖片 URL 格式 (需包含 http:// 或 https://)");return}a.value.push(m),g.value=""}},handleFileChange:m=>{const f=m.target,y=f.files?.[0];if(f.value="",!y){i.value="未選擇檔案。",c.value=null;return}if(!y.type.startsWith("image/")){alert("請選擇有效的圖片檔案！"),i.value="未選擇檔案。",c.value=null;return}if(a.value.length>=F){alert(`最多只能上傳 ${F} 張圖片！`),i.value="圖片數量已達上限，請先刪除圖片。",c.value=null;return}c.value=y,i.value=y.name},triggerUpload:async()=>{const m=c.value;if(!m){alert("請先選擇圖片檔案");return}if(!r.value)try{r.value=!0;const f=await fe(m);a.value.push(f),c.value=null,i.value="未選擇檔案。",alert("圖片上傳成功！")}catch(f){console.error("圖片上傳失敗:",f),alert("圖片上傳失敗，請稍後再試。")}finally{r.value=!1}},deleteImage:m=>{a.value.splice(m,1)},resetImages:(m=[])=>{a.value=[...m].filter(Boolean),g.value="",i.value="未選擇檔案。",c.value=null,r.value=!1}}}const G=()=>({id:"",title:"",origin_price:0,price:0,category:"",unit:"",num:0,content:"",description:"",is_enabled:1,imageUrl:"",imagesUrl:[""]});function ve(){const o=b(G()),a=b("新增商品"),g=c=>{c?(o.value={...c},a.value="編輯商品"):i()},i=()=>{o.value=G(),a.value="新增商品"};return{form:o,formTitle:a,loadProduct:g,resetForm:i}}const _e={class:"modal-dialog modal-dialog-centered modal-lg"},ye={class:"modal-content rounded-lg"},he={class:"modal-header"},Ue={class:"modal-title",id:"addNewProductModalLabel"},ke={class:"modal-body"},$e={class:"row"},we={class:"col-md-6"},xe={class:"mb-3"},Ce={class:"row"},Pe={class:"col-6 mb-3"},Me={class:"col-6 mb-3"},Ie={class:"row"},De={class:"col-6 mb-3"},Re={class:"col-6 mb-3"},Ve={class:"mb-3"},Fe={class:"mb-3"},Le={class:"mb-3 d-flex align-items-center"},Ne={class:"form-check form-switch"},je={class:"col-md-6"},Se={class:"mb-3"},Te={class:"input-group mb-2"},Ae=["disabled"],Be={class:"input-group mb-2"},Ee={class:"file-name-display form-control rounded-lg"},ze=["disabled"],Ge={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},Oe={class:"mb-3"},qe={id:"imagesContainer",class:"d-flex flex-wrap gap-2"},He=["src"],We=["onClick"],Xe=["src"],Je={class:"modal-footer"},Ke=["disabled"],Qe=O({__name:"ProductModal",props:{product:{}},emits:["get-products"],setup(o,{expose:a,emit:g}){const i=g,c=z("modalRef");let r=null;q(()=>{c.value&&(r=new ne(c.value))}),Z(()=>{r&&r.dispose()});const w=()=>{r&&r.show()},x=()=>{r&&(r.hide(),m())},{form:d,formTitle:M,loadProduct:V,resetForm:m}=ve(),{uploadedImages:f,imageUrlInput:y,fileToUpload:j,fileNameDisplay:u,isUploading:n,addImageUrl:p,triggerUpload:I,handleFileChange:S,deleteImage:X,resetImages:T}=be();ee(()=>o.product,C=>{C.id?(V(C),T([C.imageUrl,...C.imagesUrl])):(V(null),T([]))},{immediate:!0,deep:!0});const J=H(()=>!!o.product.id),A=b(!1),K=async()=>{const[C,...t]=f.value,{id:s,...h}=d.value;h.imageUrl=C,h.imagesUrl=t;const B={...h,imagesUrl:h.imagesUrl?h.imagesUrl:[""]};A.value=!0;try{J.value&&s?await ce({data:B,id:s}):await ue(B),T([]),x()}catch(Q){alert("新增/編輯產品失敗"),console.error(Q)}finally{A.value=!1,i("get-products")}};return a({openModal:w,closeModal:x}),(C,t)=>(_(),v("div",{ref_key:"modalRef",ref:c,class:"modal fade",id:"addNewProductModal",tabindex:"-1","aria-labelledby":"addNewProductModalLabel","aria-hidden":"true"},[e("div",_e,[e("div",ye,[e("div",he,[e("h5",Ue,$(l(M)),1),e("button",{onClick:x,type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]),e("div",ke,[e("div",$e,[e("div",we,[e("form",null,[e("div",xe,[t[12]||(t[12]=e("label",{for:"productName",class:"form-label"},"商品名稱",-1)),U(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>l(d).title=s),type:"text",class:"form-control rounded-lg",id:"productName"},null,512),[[k,l(d).title]])]),e("div",Ce,[e("div",Pe,[t[13]||(t[13]=e("label",{for:"productOriginalPrice",class:"form-label"},"原價",-1)),U(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>l(d).origin_price=s),type:"number",class:"form-control rounded-lg",id:"productOriginalPrice"},null,512),[[k,l(d).origin_price]])]),e("div",Me,[t[14]||(t[14]=e("label",{for:"productPrice",class:"form-label"},"售價",-1)),U(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>l(d).price=s),type:"number",class:"form-control rounded-lg",id:"productPrice"},null,512),[[k,l(d).price]])])]),e("div",Ie,[e("div",De,[t[15]||(t[15]=e("label",{for:"productCategory",class:"form-label"},"分類",-1)),U(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>l(d).category=s),class:"form-control rounded-lg",id:"productCategory"},null,512),[[k,l(d).category]])]),e("div",Re,[t[16]||(t[16]=e("label",{for:"productUnit",class:"form-label"},"單位",-1)),U(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>l(d).unit=s),class:"form-control rounded-lg",id:"productUnit"},null,512),[[k,l(d).unit]])])]),e("div",Ve,[t[17]||(t[17]=e("label",{for:"productDescription",class:"form-label"},"商品內容",-1)),U(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=s=>l(d).content=s),class:"form-control rounded-lg",id:"productDescription",rows:"4"},null,512),[[k,l(d).content]])]),e("div",Fe,[t[18]||(t[18]=e("label",{for:"productDescription",class:"form-label"},"商品描述",-1)),U(e("textarea",{"onUpdate:modelValue":t[6]||(t[6]=s=>l(d).description=s),class:"form-control rounded-lg",id:"productDescription",rows:"4"},null,512),[[k,l(d).description]])]),e("div",Le,[t[19]||(t[19]=e("label",{class:"form-label me-3 mb-0"},"啟用",-1)),e("div",Ne,[U(e("input",{"onUpdate:modelValue":t[7]||(t[7]=s=>l(d).is_enabled=s),class:"form-check-input",type:"checkbox",id:"flexSwitchProductEnable","true-value":1,"false-value":0},null,512),[[te,l(d).is_enabled]])])])])]),e("div",je,[e("div",Se,[t[21]||(t[21]=e("label",{class:"form-label"},"上傳圖片 (最多 4 張)",-1)),e("div",Te,[U(e("input",{type:"url",class:"form-control rounded-lg",placeholder:"輸入圖片連結","onUpdate:modelValue":t[8]||(t[8]=s=>le(y)?y.value=s:null)},null,512),[[k,l(y)]]),e("button",{class:"btn btn-outline-secondary rounded-lg ms-2",type:"button",onClick:t[9]||(t[9]=(...s)=>l(p)&&l(p)(...s)),disabled:l(f).length>=4}," 新增連結 ",8,Ae)]),e("div",Be,[t[20]||(t[20]=e("label",{class:"input-group-text rounded-lg",for:"imageInputFile"},"瀏覽...",-1)),e("input",{onChange:t[10]||(t[10]=(...s)=>l(S)&&l(S)(...s)),type:"file",class:"form-control d-none",id:"imageInputFile",accept:".jpg, .jpeg, .png"},null,32),e("div",Ee,$(l(u)),1),e("button",{onClick:t[11]||(t[11]=(...s)=>l(I)&&l(I)(...s)),disabled:!l(j)||l(n)||l(f).length>=4,class:"btn btn-outline-secondary rounded-lg ms-2",type:"button"},[l(n)?(_(),v("span",Ge)):oe("",!0),W(" "+$(l(n)?"上傳中...":"上傳圖片"),1)],8,ze)])]),e("div",Oe,[t[23]||(t[23]=e("div",{class:"d-flex justify-content-between align-items-center mb-2"},[e("label",{class:"form-label mb-0"},"已上傳圖片")],-1)),e("div",qe,[(_(!0),v(D,null,N(l(f),(s,h)=>(_(),v("div",{key:h,class:L(["image-preview-thumbnail-container",{"main-image":h===0}])},[e("img",{src:s,class:"image-preview-thumbnail",alt:"商品圖片預覽"},null,8,He),e("button",{class:"btn btn-danger btn-sm delete-btn",onClick:B=>l(X)(h)},[...t[22]||(t[22]=[e("i",{class:"fas fa-times"},null,-1)])],8,We)],2))),128)),(_(!0),v(D,null,N(4-l(f).length,s=>(_(),v("div",{key:"placeholder-"+s,class:"image-preview-thumbnail-container"},[e("img",{src:`https://placehold.co/100x100/e9ecef/adb5bd?text=Image+${l(f).length+s}`,class:"image-preview-thumbnail"},null,8,Xe)]))),128))])])])])]),e("div",Je,[e("button",{onClick:x,type:"button",class:"btn btn-outline-secondary rounded-lg"}," 取消 "),e("button",{onClick:K,disabled:A.value,type:"button",class:"btn btn-dark rounded-lg"}," 儲存 ",8,Ke)])])])],512))}}),Ye={class:"d-flex justify-content-between align-items-center mb-4"},Ze=["disabled"],et={class:"card shadow-sm rounded-lg flex-grow-1"},tt={class:"card-body p-4"},lt={class:"table-responsive"},ot={class:"table table-hover align-middle"},st={class:"text-center"},at={class:"form-check form-switch d-flex justify-content-center align-items-center"},nt=["checked"],it={class:"text-nowrap"},rt=["onClick"],dt=["onClick"],ut={class:"d-flex justify-content-center mt-4"},ct={class:"pagination"},pt={class:"page-item"},mt=["disabled"],gt=["onClick","disabled"],ft={class:"page-item"},bt=["disabled"],Ut=O({__name:"ProductManagement",setup(o){const a=z("productModalRef"),g=z("deleteModalRef"),i=b("1"),c=b([]),r=b({total_pages:0,current_page:0,has_pre:!1,has_next:!1,category:""}),w=b(!1),x=b(""),d=H(()=>{const u=x.value.trim().toLowerCase();return u?c.value.filter(n=>n.title.toLowerCase().includes(u)||n.category.toLowerCase().includes(u)):c.value}),M=async()=>{w.value=!0;try{const u=await de({page:i.value});c.value=u.data.products,r.value=u.data.pagination}catch(u){alert("取得產品列表失敗"),console.error(u)}finally{w.value=!1}};q(()=>{M()});const m=b({id:"",title:"",origin_price:0,price:0,category:"",unit:"",num:0,content:"",description:"",is_enabled:1,imageUrl:"",imagesUrl:[""]}),f=(u=null)=>{u&&(m.value={...u,imagesUrl:u.imagesUrl?[...u.imagesUrl]:[""]}),a.value?.openModal()},y=u=>{g.value?.openModal(()=>j(u))},j=async u=>{try{await pe(u)}catch(n){alert("刪除商品失敗"),console.error(n)}finally{M()}};return(u,n)=>(_(),v(D,null,[e("div",Ye,[e("button",{onClick:n[0]||(n[0]=p=>f(null)),type:"button",class:"btn btn-dark rounded-lg px-4 py-2",disabled:w.value},[...n[3]||(n[3]=[e("i",{class:"fas fa-plus me-2"},null,-1),W("新增商品 ",-1)])],8,Ze)]),E(ie,{loading:w.value},{default:se(()=>[e("div",et,[e("div",tt,[e("div",lt,[e("table",ot,[n[4]||(n[4]=e("thead",null,[e("tr",null,[e("th",{scope:"col"},"分類"),e("th",{scope:"col"},"商品名稱"),e("th",{scope:"col"},"原價"),e("th",{scope:"col"},"售價"),e("th",{scope:"col",class:"text-center"},"啟用"),e("th",{scope:"col"})])],-1)),e("tbody",null,[(_(!0),v(D,null,N(d.value,p=>(_(),v("tr",{key:p.id},[e("td",null,$(p.category),1),e("td",null,$(p.title),1),e("td",null,$(p.origin_price),1),e("td",null,$(p.price),1),e("td",st,[e("div",at,[e("input",{readonly:"",class:"form-check-input",style:{"pointer-events":"none"},type:"checkbox",id:"flexSwitchCheckDefault1",checked:!!p.is_enabled},null,8,nt)])]),e("td",it,[e("button",{onClick:I=>f(p),type:"button",class:"btn btn-sm btn-outline-dark rounded-lg me-2"}," 編輯 ",8,rt),e("button",{onClick:I=>y(p.id),type:"button",class:"btn btn-sm btn-outline-danger rounded-lg"}," 刪除 ",8,dt)])]))),128))])])]),e("nav",ut,[e("ul",ct,[e("li",pt,[e("button",{onClick:n[1]||(n[1]=p=>i.value=String(Number(i.value)-1)),disabled:!r.value?.has_pre,type:"button",class:L(["page-link",{disabled:!r.value?.has_pre}]),"aria-label":"Previous"},[...n[5]||(n[5]=[e("span",{"aria-hidden":"true"},"«",-1)])],10,mt)]),(_(!0),v(D,null,N(r.value?.total_pages,(p,I)=>(_(),v("li",{key:I,class:"page-item"},[e("button",{onClick:S=>i.value=p.toString(),disabled:i.value===p.toString(),type:"button",class:L(["page-link",{active:i.value===p.toString()}])},$(p),11,gt)]))),128)),e("li",ft,[e("button",{onClick:n[2]||(n[2]=p=>i.value=String(Number(i.value)+1)),disabled:!r.value?.has_next,class:L(["page-link",{disabled:!r.value?.has_next}]),type:"button","aria-label":"Next"},[...n[6]||(n[6]=[e("span",{"aria-hidden":"true"},"»",-1)])],10,bt)])])])])])]),_:1},8,["loading"]),E(Qe,{ref_key:"productModalRef",ref:a,product:m.value,onGetProducts:M},null,8,["product"]),E(ae,{ref_key:"deleteModalRef",ref:g,title:"刪除商品",content:"確定要刪除該商品嗎？"},null,512)],64))}});export{Ut as default};
